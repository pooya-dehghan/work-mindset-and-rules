# راهنمای رسمی Merge Request (MR)

## هدف

Merge Request ابزار اصلی ما برای:

* حفظ کیفیت کد
* مستندسازی تصمیم‌ها
* انتقال دانش
* و جلوگیری از بدهی فنی پنهان

MR فقط برای merge کردن کد نیست؛
**MR نقطه‌ی تلاقی کد، تصمیم و ارتباط انسانی است.**

---

## ۱. دامنه‌ی تغییر (Scope)

### قانون

هر MR باید فقط **یک تغییر منطقی** را پوشش دهد:

* یک باگ
* یک فیچر
* یا یک ریفکتور مشخص

ترکیب این موارد در یک MR ممنوع است.

### دلیل

* تغییرات کوچک قابل‌فهم‌تر هستند
* review دقیق‌تر می‌شود
* rollback امن‌تر است
* احتمال merge سریع‌تر بالا می‌رود

---

## ۲. عنوان Merge Request

### قانون

عنوان باید:

* کوتاه
* دقیق
* و مبتنی بر «نیت» باشد

فرمت پیشنهادی:

```
<عمل اصلی> + <بخش سیستم> + <دلیل>
```

مثال:

* رفع race condition در Order Finalization
* اضافه کردن retry به Payment Gateway Adapter

### دلیل

عنوان MR همان چیزی است که در تاریخچه باقی می‌ماند.
عنوان ضعیف یعنی تاریخچه‌ی بی‌ارزش.

---

## ۳. توضیحات MR (اجباری)

هر MR **باید** این بخش‌ها را داشته باشد:

### What – چه چیزی تغییر کرده؟

توضیح خلاصه‌ی تغییرات انجام‌شده.

### Why – چرا این تغییر لازم بوده؟

مشکل، نیاز یا تصمیمی که باعث این تغییر شده.

### How – چطور پیاده‌سازی شده؟

تصمیم‌های مهم طراحی، trade-offها، یا الگوهای استفاده‌شده.

### Risk / Impact – ریسک یا اثرات جانبی

* چه چیزی ممکن است خراب شود؟
* چه بخش‌هایی تحت تأثیر هستند؟

### Testing – چطور بررسی شده؟

* تست واحد
* تست یکپارچه
* تست دستی (در صورت نیاز)

### دلیل

کد «چطور» را نشان می‌دهد،
اما **MR باید «چرا» را حفظ کند**.

---

## ۴. ارجاع به تصمیم یا تسک

### قانون

هر MR باید به یکی از موارد زیر لینک شود:

* Ticket
* RFC
* ADR
* یا تصمیم مکتوب قابل ارجاع

### دلیل

این کار از تکرار بحث‌های قدیمی جلوگیری می‌کند و مسیر تصمیم‌گیری را شفاف نگه می‌دارد.

---

## ۵. اندازه‌ی تغییرات

### قانون

* زیر ۳۰۰ خط تغییر: ایده‌آل
* بالای ۶۰۰ خط: نیازمند توجیه یا شکستن به چند MR

### دلیل

هرچه diff بزرگ‌تر شود:

* کیفیت review پایین‌تر می‌آید
* باگ‌ها پنهان‌تر می‌شوند
* merge کندتر می‌شود

---

## ۶. تغییرات نامرتبط ممنوع

### قانون

موارد زیر فقط در MR جداگانه مجازند:

* ریفکتور
* فرمت‌بندی
* تغییر نام‌ها
* cleanupهای عمومی

### دلیل

تغییرات نامرتبط نویز ایجاد می‌کنند و تمرکز reviewer را می‌شکنند.

---

## ۷. تست‌ها

### قانون

هر MR باید:

* برای رفتار جدید تست اضافه کند
* برای رفتار تغییرکرده تست را آپدیت کند
* یا دلیل مستند برای نبود تست ارائه دهد

### دلیل

تست‌ها تضمین رفتار سیستم هستند، نه فقط ابزار CI.
بدون تست، کیفیت به حافظه‌ی انسان وابسته می‌شود.

---

## ۸. وضعیت CI و Build

### قانون

MR فقط زمانی قابل merge است که:

* build محلی موفق باشد
* تمام CI پاس شده باشد
* تست flaky معرفی نشده باشد

### دلیل

CI غیرقابل اعتماد = تیم غیرقابل اعتماد.

---

## ۹. تغییرات Contract و API

### قانون

هر تغییری در:

* API عمومی
* Proto / Schema
* Database
* Event یا Message

باید:

* صریحاً ذکر شود
* و در صورت نیاز version شود

### دلیل

Contractها مرز بین سیستم‌ها هستند.
شکستن بی‌صدا یعنی حادثه‌ی حتمی.

---

## ۱۰. Backward Compatibility

### قانون

سازگاری عقب‌رو پیش‌فرض است.
شکستن آن باید آگاهانه، مستند و تاییدشده باشد.

### دلیل

سیستم‌ها به رفتار واقعی وابسته‌اند، نه فرضیات ما.

---

## ۱۱. امنیت و کارایی

### قانون

در MR مشخص شود:

* آیا ورودی غیرقابل اعتماد پردازش می‌شود؟
* آیا latency، memory یا throughput تغییر می‌کند؟

### دلیل

بیشتر مشکلات امنیتی و performance ناخواسته‌اند، نه عمدی.

---

## ۱۲. شفافیت کامل

### قانون

اگر چیزی:

* موقتی
* workaround
* آزمایشی
* یا از نظر فنی نازیبا ولی ضروری است

باید واضح نوشته شود.

### دلیل

بدهی فنی پنهان، خطرناک‌ترین نوع بدهی است.

---

## ۱۳. فرهنگ Review

### قانون

* reviewer قاضی نیست
* نویسنده مسئول کیفیت نهایی است
* اختلاف نظر فنی با دلیل و مستند حل می‌شود

### دلیل

Code Review همکاری است، نه نبرد قدرت.

---

## ۱۴. تاریخچه‌ی Commit

### قانون

قبل از merge:

* commitهای موقتی تمیز شوند
* یا به‌صورت معنادار سازمان‌دهی شوند

### دلیل

Git history ابزار دیباگ و یادگیری است.

---

## ۱۵. مالکیت MR

### قانون

نویسنده‌ی MR مسئول:

* پاسخ به review
* رفع CI
* آپدیت داکیومنت
* پیگیری بعد از merge است

### دلیل

مالکیت مبهم یعنی کار نیمه‌تمام.

---

## اصل نهایی

> Merge Request قراردادی است
> بین مهندسان امروز و مهندسان آینده.

اگر این MR شش ماه بعد قابل دفاع نیست،
امروز هم نباید merge شود.

